# Copyright (c) 2024 - 2025, Oracle and/or its affiliates. All rights reserved.
# Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl/.

"""The heuristic analyzer to check .whl file absence."""

import logging

from macaron.errors import HeuristicAnalyzerValueError
from macaron.json_tools import JsonType
from macaron.malware_analyzer.pypi_heuristics.base_analyzer import BaseHeuristicAnalyzer
from macaron.malware_analyzer.pypi_heuristics.heuristics import HeuristicResult, Heuristics
from macaron.slsa_analyzer.package_registry.pypi_registry import PyPIPackageJsonAsset

logger: logging.Logger = logging.getLogger(__name__)


class WheelAbsenceAnalyzer(BaseHeuristicAnalyzer):
    """
    Analyze to see if a .whl file is available for the package.

    If a package is distributed with a .whl file, this heuristic passes. Otherwise, the
    heuristic fails.
    """

    def __init__(self) -> None:
        super().__init__(
            name="wheel_absence_analyzer",
            heuristic=Heuristics.WHEEL_ABSENCE,
            depends_on=None,
        )

    def analyze(self, pypi_package_json: PyPIPackageJsonAsset) -> tuple[HeuristicResult, dict[str, JsonType]]:
        """Analyze the package.

        Parameters
        ----------
        pypi_package_json: PyPIPackageJsonAsset
            The PyPI package JSON asset object.

        Returns
        -------
        tuple[HeuristicResult, dict[str, JsonType]]:
            The result and related information collected during the analysis.

        Raises
        ------
        HeuristicAnalyzerValueError
            If there is missing package information.
        """
        if not pypi_package_json.get_inspector_links():
            error_msg = "Unable to retrieve PyPI inspector information about package"
            logger.debug(error_msg)
            raise HeuristicAnalyzerValueError(error_msg)

        detail_info: dict = {"inspector_links": pypi_package_json.inspector_asset.package_link_reachability}

        # At least one wheel file exists
        if len(pypi_package_json.inspector_asset.package_whl_links) > 0:
            return HeuristicResult.PASS, detail_info

        return HeuristicResult.FAIL, detail_info
