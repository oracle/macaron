# Copyright (c) 2024 - 2024, Oracle and/or its affiliates. All rights reserved.
# Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl/.


"""Analyzer checks the packages contain one release."""

from macaron.malware_analyzer.pypi_heuristics.analysis_result import HeuristicResult
from macaron.malware_analyzer.pypi_heuristics.base_analyzer import BaseHeuristicAnalyzer
from macaron.malware_analyzer.pypi_heuristics.heuristics import HEURISTIC
from macaron.slsa_analyzer.package_registry.pypi_registry import PyPIRegistry


class OneReleaseAnalyzer(BaseHeuristicAnalyzer):
    """Analyzer checks heuristic."""

    def __init__(self) -> None:
        super().__init__(name="one_release_analyzer", heuristic=HEURISTIC.ONE_RELEASE, depends_on=None)

    def analyze(self, api_client: PyPIRegistry) -> tuple[HeuristicResult, dict]:
        """Check the releases' total is one.

        Returns
        -------
            tuple[HeuristicResult, dict]: Result and confidence.
        """
        releases: dict | None = api_client.get_releases()
        if releases is None:
            return HeuristicResult.SKIP, {"releases": {}}

        if len(releases) == 1:
            return HeuristicResult.FAIL, {"releases": releases}  # Higher false positive, so we keep it MEDIUM
        return HeuristicResult.PASS, {"releases": releases}
