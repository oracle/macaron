# Copyright (c) 2024 - 2025, Oracle and/or its affiliates. All rights reserved.
# Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl/.

"""This analyzer checks if a PyPI package has minimal .pyi stub content."""

import logging
import os

from macaron.json_tools import JsonType
from macaron.malware_analyzer.pypi_heuristics.base_analyzer import BaseHeuristicAnalyzer
from macaron.malware_analyzer.pypi_heuristics.heuristics import HeuristicResult, Heuristics
from macaron.slsa_analyzer.package_registry.pypi_registry import PyPIPackageJsonAsset

logger: logging.Logger = logging.getLogger(__name__)


class TypeStubFileAnalyzer(BaseHeuristicAnalyzer):
    """Check whether the package has minimal .pyi stub content."""

    FILES_THRESHOLD = 10

    def __init__(self) -> None:
        super().__init__(
            name="type_stub_file",
            heuristic=Heuristics.TYPE_STUB_FILE,
            depends_on=None,
        )

    def analyze(self, pypi_package_json: PyPIPackageJsonAsset) -> tuple[HeuristicResult, dict[str, JsonType]]:
        """Analyze the package.

        Parameters
        ----------
        pypi_package_json: PyPIPackageJsonAsset
            The PyPI package JSON asset object.

        Returns
        -------
        tuple[HeuristicResult, dict[str, JsonType]]:
            The result and related information collected during the analysis.
        """
        # TODO: .pyi stub files may be present in both source distributions (sdist) and wheels.
        # Currently, we only check the sdist, which can lead to false positives in this heuristic.
        # To improve accuracy, we should also check for stub files in the wheel distribution.
        result = pypi_package_json.download_sourcecode()
        if not result:
            return HeuristicResult.SKIP, {"message": "No source code files have been downloaded.", "pyi_files": 0}

        file_count = sum(
            sum(1 for f in files if f.endswith(".pyi"))
            for _, _, files in os.walk(pypi_package_json.package_sourcecode_path)
        )

        if file_count >= self.FILES_THRESHOLD:
            return HeuristicResult.PASS, {"message": "Package has sufficient pyi files", "pyi_files": file_count}

        return HeuristicResult.FAIL, {"message": "Not enough pyi files found", "pyi_files": file_count}
