# Copyright (c) 2024 - 2024, Oracle and/or its affiliates. All rights reserved.
# Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl/.

"""Analyzer checks whether the maintainers' join date closer to latest package's release date."""

from datetime import datetime, timedelta

from macaron.config.defaults import defaults
from macaron.malware_analyzer.datetime_parser import parse_datetime
from macaron.malware_analyzer.pypi_heuristics.base_analyzer import BaseHeuristicAnalyzer
from macaron.malware_analyzer.pypi_heuristics.heuristics import HeuristicResult, Heuristics
from macaron.slsa_analyzer.package_registry.pypi_registry import PyPIRegistry


class CloserReleaseJoinDateAnalyzer(BaseHeuristicAnalyzer):
    """Analyzer checks the heuristic.

    Note
    ----
        If any maintainer's date duration is larger than threshold,
        we consider it as "PASS".
    """

    def __init__(self) -> None:
        super().__init__(
            name="closer_release_join_date_analyzer", heuristic=Heuristics.CLOSER_RELEASE_JOIN_DATE, depends_on=None
        )
        self.gap_threshold: int = self._load_defaults()

    def _load_defaults(self) -> int:
        """Load the default values from defaults.ini."""
        section_name = "heuristic.pypi"
        if defaults.has_section(section_name):
            section = defaults[section_name]
            return int(section.get("timedelta_threshold_of_join_release"))
        return 5

    def _get_maintainers_join_date(self, api_client: PyPIRegistry) -> list[datetime] | None:
        """Get the join date of the maintainers.

        Returns
        -------
            list[datetime] | None: Maintainers join date.

        Note
        ----
            Each package might have multiple maintainers.
        """
        maintainers: list | None = api_client.get_maintainer_of_package()
        if maintainers is None:
            return None

        join_dates: list[datetime] = []
        for maintainer in maintainers:
            maintainer_join_date = api_client.get_maintainer_join_date(maintainer)
            if maintainer_join_date is not None:
                join_dates.append(maintainer_join_date)
        return join_dates

    def _get_latest_release_date(self, api_client: PyPIRegistry) -> datetime | None:
        """Get package's latest release date.

        Returns
        -------
            datetime | None: Package's latest release date.
        """
        upload_time: str | None = api_client.get_latest_release_upload_time()
        if upload_time:
            datetime_format: str = "%Y-%m-%dT%H:%M:%S"
            res: datetime | None = parse_datetime(upload_time, datetime_format)
            if res:
                return res
        return None

    def analyze(self, api_client: PyPIRegistry) -> tuple[HeuristicResult, dict]:
        """Check whether the maintainers' join date closer to package's latest release date.

        Returns
        -------
            tuple[HeuristicResult, dict]: Result and confidence.
        """
        maintainers_join_date: list[datetime] | None = self._get_maintainers_join_date(api_client)
        latest_release_date: datetime | None = self._get_latest_release_date(api_client)
        detail_info = {
            "maintainers_join_date": (
                [date.strftime("%Y-%m-%d %H:%M:%S") for date in maintainers_join_date] if maintainers_join_date else []
            ),
            "latest_release_date": latest_release_date.strftime("%Y-%m-%d %H:%M:%S") if latest_release_date else "",
        }

        if maintainers_join_date is None or latest_release_date is None:
            return HeuristicResult.SKIP, detail_info

        for date in maintainers_join_date:
            difference = abs(latest_release_date - date)
            threshold_delta = timedelta(days=self.gap_threshold)

            if difference >= threshold_delta:
                return HeuristicResult.PASS, detail_info
        return HeuristicResult.FAIL, detail_info
