# Implementation of Heuristic Malware Detector

## PyPI Ecosystem

Malware detection is achieved using a combination of metadata and source code heuristics. Certain combinations of the results of these heuristics are indicators of a malicious package.

When a heuristic fails, with `HeuristicResult.FAIL`, then that is an indicator by that heuristic of suspicious behaviour. When a heuristic passes, with `HeuristicResult.PASS`, then that is an indicator of benign behavior. When a heuristic is skipped, returning `HeuristicResult.SKIP`, then this means that heuristic was not applicable to the package, due to either package details or dependencies on other heuristics. When a heuristic encounters a malformed package, a `HeuristicAnalyzerValueError` is raised. The following heuristics are currently run sequentially to gauge package maliciousness.

1. **Empty Project Link**
   - **Description**: Checks whether the package contains any project links (e.g., documents or Git
   Repositories). Many malicious packages do not include any project links.
   - **Rule**: Return `HeuristicResult.FAIL` when there are no project links; otherwise, return `HeuristicResult.PASS`.

2. **Source Code Repo**
   - **Description**: Check's if Macaron was able to find a repository containing this package's source code (i.e., checks if
   one exists).
   - **Rule**: Return `HeuristicResult.FAIL` if no repository was found; otherwise, return `HeuristicResult.PASS`.
   - **Dependency**: Will be run if the Empty Project Link heuristic passes.

3. **One Release**
   - **Description**: Checks whether the package has only one release.
   - **Rule**: Return `HeuristicResult.FAIL` if the package contains only one release; otherwise, return `HeuristicResult.PASS`.

4. **High Release Frequency**
   - **Description**: Checks if the package released multiple versions within a short timeframe. We calculate
   the release frequency and define a default frequency threshold of 2 days.
   - **Rule**: Return `HeuristicResult.FAIL` if the frequency is higher than the threshold; otherwise, return `HeuristicResult.PASS`.
   - **Dependency**: Will be run if the One Release heuristic passes.

5. **Unchanged Release**
   - **Description**: Checks if the content of releases remains unchanged using the `sha256` digest of the package source.
   - **Rule**: Return `HeuristicResult.FAIL` if the content of any two releases is identical; otherwise, return `HeuristicResult.PASS`.
   - **Dependency**: Will be run if the High Release Frequency heuristic fails.

6. **Closer Release Join Date**
   - **Description**: Checks the gap between the date the maintainer(s) registered their account and the date
   of the latest release. A default threshold of 5 days is defined.
   - **Rule**: Return `HeuristicResult.FAIL` if the gap is less than the threshold for any maintainer; otherwise, return `HeuristicResult.PASS`.

7. **Suspicious Setup**
   - **Description**: Checks `setup.py` to see if there are suspicious imported modules, or
   `install_requires` packages that are installed during the package installation process. Current blacklisted packages are `base64` and `requests`. This heuristic is skipped if no `setup.py` file can be found in the package.
   - **Rule**: Return `HeuristicResult.FAIL` if the package name contains suspicious keywords; otherwise, return `HeuristicResult.PASS`.
   - **Dependency**: Will be run if the Closer Release Join Date heuristic fails.

8. **Wheel Absence**
   - **Description**: Checks for the presence of a wheel (`.whl`) file distributed with the specified package release.
   - **Rule**: Return `HeuristicResult.FAIL` if there is no wheel file present with that package release; otherwise, return `HeuristicResult.PASS`.

9. **Anomalous Version**
   - **Description**: Checks if the version number is abnormally high, checking the epoch and major version against threshold values. This does account for common date-based version number (calendar versioning) patterns.
   - **Rule**: Return `HeuristicResult.FAIL` if the major or epoch is abnormally high; otherwise, return `HeuristicResult.PASS`.
   - **Dependency**: Will be run if the One Release heuristic fails.

10. **Typosquatting Presence**
    - **Description**:  Checks if the package name is suspiciously similar to any package name in a predefined list of popular packages. The similarity check incorporates the Jaro-Winkler distance and considers keyboard layout proximity to identify potential typosquatting.
    - **Rule**: Return `HeuristicResult.FAIL` if the similarity ratio between the package name and any popular package name meets or exceeds a defined threshold; otherwise, return `HeuristicResult.PASS`.
    - **Dependency**: None.

### Contributing

When contributing an analyzer, it must meet the following requirements:

- The analyzer must be implemented in a separate file, placed in the relevant folder based on what it analyzes ([metadata](./pypi_heuristics/metadata/) or [sourcecode](./pypi_heuristics/sourcecode/)).
- The analyzer must inherit from the `BaseHeuristicAnalyzer` class and implement the `analyze` function, returning relevant information specific to the analysis.
- The analyzer name must be added to [heuristics.py](./pypi_heuristics/heuristics.py) file so it can be used for rule combinations in [detect_malicious_metadata_check.py](../slsa_analyzer/checks/detect_malicious_metadata_check.py)
- Update the `malware_rules_problog_model` in [detect_malicious_metadata_check.py](../slsa_analyzer/checks/detect_malicious_metadata_check.py) with logical statements where the heuristic should be included. When adding new rules, please follow the following guidelines:
   - Provide a [confidence value](../slsa_analyzer/checks/check_result.py) using the `Confidence` enum.
   - Ensure it is assigned to the `problog_result_access` string variable, otherwise it will not be queried and evaluated.
   - Assign a rule ID to the rule. This will be used to backtrack to determine if it was triggered.
   - Make sure to wrap pass/fail statements in `passed()` and `failed()`. Not doing so may result in undesirable behaviour, see the comments in the model for more details.
   - If there are commonly used combinations introduced by adding the heuristic, combine and justify them at the top of the static model (see `quickUndetailed` and `forceSetup` as current examples).

### Confidence Score Motivation

The original seven heuristics which started this work were Empty Project Link, Unreachable Project Links, One Release, High Release Frequency, Unchange Release, Closer Release Join Date, and Suspicious Setup. These heuristics (excluding those with a dependency) were run on 1167 packages from trusted organizations, with the following results:

| Heuristic Name   | Count |
|------------------| ----- |
| One Release      | 102   |
| Empty Link       | 45    |
| Links Missing    | 24    |
| Frequent Release | 14    |
| Suspicious Setup | 5     |

These results were used as a reference for the confidence score provided in each suspicious combination.
