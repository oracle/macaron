# Implementation of Heuristic Malware Detector

## PyPI Ecosystem

Malware detection is achieved using a combination of metadata and source code heuristics. Certain combinations of the results of these heuristics are indicators of a malicious package.

When a heuristic fails, with `HeuristicResult.FAIL`, then that is an indicator by that heuristic of suspicious behaviour. When a heuristic passes, with `HeuristicResult.PASS`, then that is an indicator of benign behavior. When a heuristic is skipped, returning `HeuristicResult.SKIP`, then this means that heuristic was not applicable to the package, due to either package details or dependencies on other heuristics. When a heuristic encounters a malformed package, a `HeuristicAnalyzerValueError` is raised. The following heuristics are currently run sequentially to gauge package maliciousness.

1. **Empty Project Link**
   - **Description**: Checks whether the package contains any project links (e.g., documents or Git
   Repositories). Many malicious packages do not include any project links.
   - **Rule**: Return `HeuristicResult.FAIL` when there are no project links; otherwise, return `HeuristicResult.PASS`.

2. **Unreachable Project Links**
   - **Description**: Checks the accessibility of the project links. This is considered an auxiliary
   heuristic since no cases have met this heuristic.
   - **Rule**: Return `HeuristicResult.FAIL` if all project links are unreachable; otherwise, return `HeuristicResult.PASS`.
   - **Dependency**: Will be run if the Empty Project Link heuristic passes.

3. **One Release**
   - **Description**: Checks whether the package has only one release.
   - **Rule**: Return `HeuristicResult.FAIL` if the package contains only one release; otherwise, return `HeuristicResult.PASS`.

4. **High Release Frequency**
   - **Description**: Checks if the package released multiple versions within a short timeframe. We calculate
   the release frequency and define a default frequency threshold of 2 days.
   - **Rule**: Return `HeuristicResult.FAIL` if the frequency is higher than the threshold; otherwise, return `HeuristicResult.PASS`.
   - **Dependency**: Will be run if the One Release heuristic passes.

5. **Unchanged Release**
   - **Description**: Checks if the content of releases remains unchanged using the `sha256` digest of the package source.
   - **Rule**: Return `HeuristicResult.FAIL` if the content of any two releases is identical; otherwise, return `HeuristicResult.PASS`.
   - **Dependency**: Will be run if the High Release Frequency heuristic fails.

6. **Closer Release Join Date**
   - **Description**: Checks the gap between the date the maintainer(s) registered their account and the date
   of the latest release. A default threshold of 5 days is defined.
   - **Rule**: Return `HeuristicResult.FAIL` if the gap is less than the threshold for any maintainer; otherwise, return `HeuristicResult.PASS`.

7. **Suspicious Setup**
   - **Description**: Checks `setup.py` to see if there are suspicious imported modules, or
   `install_requires` packages that are installed during the package installation process. Current blacklisted packages are `base64` and `requests`. This heuristic is skipped if no `setup.py` file can be found in the package.
   - **Rule**: Return `HeuristicResult.FAIL` if the package name contains suspicious keywords; otherwise, return `HeuristicResult.PASS`.
   - **Dependency**: Will be run if the Closer Release Join Date heuristic fails.

8. **Wheel Absence**
   - **Description**: Checks for the presence of a wheel (`.whl`) file distributed with the specified package release.
   - **Rule**: Return `HeuristicResult.FAIL` if there is no wheel file present with that package release; otherwise, return `HeuristicResult.PASS`.

9. **Anomalous Version**
   - **Description**: Checks if the version number is abnormally high, checking the epoch and major version against threshold values. This does account for common date-based version number (calendar versioning) patterns.
   - **Rule**: Return `HeuristicResult.FAIL` if the major or epoch is abnormally high; otherwise, return `HeuristicResult.PASS`.
   - **Dependency**: Will be run if the One Release heuristic fails.

### Confidence Score Motivation

The original seven heuristics which started this work were Empty Project Link, Unreachable Project Links, One Release, High Release Frequency, Unchange Release, Closer Release Join Date, and Suspicious Setup. These heuristics (excluding those with a dependency) were run on 1167 packages from trusted organizations, with the following results:

| Heuristic Name   | Count |
|------------------| ----- |
| One Release      | 102   |
| Empty Link       | 45    |
| Links Missing    | 24    |
| Frequent Release | 14    |
| Suspicious Setup | 5     |

These results were used as a reference for the confidence score provided in each suspicious combination.
