{#
    Copyright (c) 2023 - 2023, Oracle and/or its affiliates. All rights reserved.
    Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl/
#}

{%- import "helper_macros.j2" as macaron_macros -%}

{%- extends "base_template.html" -%}

{#
    This section contains macros that are used to render elements in this template.
    We define these macros separately so that we could use correct
    indentation for the whole block.
#}

{#
    Render the target information table.
#}
{%- macro render_target_info_table(target_info_data) -%}
{% call macaron_macros.render_table(class="target_info", has_header=false) %}
    {% for key, value in target_info_data | items %}
    <tr>
        <th>
            {{ key | replace("_", " ") | capitalize }}
        </th>
        <td>
            {{ value }}
        </td>
    </tr>
    {% endfor %}
{% endcall %}
{%- endmacro -%}

{#
    Render the check report for the target as a table with headers.
#}
{%- macro render_checks_report(checks_report_data) -%}
{%- set headers = checks_report_data | get_headers -%}
{% call macaron_macros.render_table(header_names=headers, has_header=true, class="checks_report") %}
    {% for item in checks_report_data %}
    <tr>
    {% for header in headers %}
        {% if header == "slsa_requirements" %}
        <td>
            <ul>
            {% for ele in item[header] %}
                <li>{{ ele }}</li>
            {% endfor %}
            </ul>
        </td>
        {% elif header == "result_type" %}
        <td class={{ item[header] | get_check_result_color }}>{{ item[header].value }}</td>
        {% elif header == "justification" %}
        <td>
            <ul>
            {% for ele in item[header] %}
                {% if ele is mapping %}
                    {% for key, value in ele | items %}
                <li>{{ key }}: {{ macaron_macros.render_hyperlink(href=value, display_text=value) }}</li>
                    {% endfor %}
                {% else %}
                <li>{{ ele }}</li>
                {% endif %}
            {% endfor %}
            </ul>
        </td>
        {% else %}
        <td>{{ item[header] }}</td>
        {% endif %}
    {% endfor %}
    </tr>
    {% endfor %}
{% endcall %}
{%- endmacro -%}

{#
    Render the summary of dependencies check reports.
#}
{%- macro render_dep_summary(dep_summary_data) -%}
{%- set headers = dep_summary_data | get_headers -%}
{% call macaron_macros.render_table(header_names=headers, has_header=true, class="dep_summary") %}
    {% for item in dep_summary_data %}
    <tr>
        {% for header in headers %}
        <td>{{ item[header] }}</td>
        {% endfor %}
    </tr>
    {% endfor %}
{% endcall %}
{%- endmacro -%}

{#
    Render the status for each of the dependencies analysis.
#}
{%- macro render_dep_status(dep_status_data) -%}
{%- set headers = dep_status_data | get_headers -%}
{% call macaron_macros.render_table(header_names=headers, has_header=true, class="dep_status") %}
    {% for item in dep_status_data %}
    <tr>
    {% for header in headers %}
        {% if header == "report" %}
        {% if item[header] %}
        <td>{{ macaron_macros.render_hyperlink(item[header], display_text="Open report.") }}</td>
        {% else %}
        <td>Not available.</td>
        {% endif %}
        {% elif header == "status" %}
        <td class={{ item[header] | get_dep_status_color }}>{{ item[header].value }}</td>
        {% else %}
        <td>{{ item[header] }}</td>
        {% endif %}
    {% endfor %}
    </tr>
    {% endfor %}
{% endcall %}
{%- endmacro -%}

{#
    Render the status for the target.
#}
{%- macro render_target_metadata(target_metadata) -%}
{% call macaron_macros.render_table(class="target_info", has_header=false) %}
    {% for key, value in target_metadata.summary | items %}
    <tr>
        <th>
            {{ key | replace("_", " ") | capitalize }}
        </th>
        {% if key == "status" %}
        <td class={{ value | get_dep_status_color }}>{{ value.value }}</td>
        {% elif key == "report" %}
        {# We ignore this field. #}
        {% else %}
        <td>
            {{ value }}
        </td>
        {% endif %}
    </tr>
    {% endfor %}
{% endcall %}
{%- endmacro -%}

{# -------------------------------------------- #}

{#
    This section is where we fill in the blocks defined in base_template.html.
    The data for this template is passed in as a Python dictionary by the HTMLReporter. We can access those data by
    specifying the keys to the required value field.
    For example, if the data from HTMLReporter is:
    {
        "metadata": {
            "boo": 1,
            "foo": 2
        }
    }
    Within the Jinja2 template, ``{{ metadata.boo }}`` will be rendered as ``1``
#}

{% block timestamps %}
{{ metadata.timestamps | indent(12, first=true) }}
{% endblock %}

{% block content %}
    <div class="table_caption">Target information</div>
    {% if target %}
    {#
        Display the related section only when the target information is available :
            - Target information
            - Provenance summary
            - Check report
    #}
    {{ render_target_info_table(target.info) | indent(4) }}

    <div class='space_divider'></div>

    <div class="table_caption">Provenance summary</div>
    <div id= "prov_justification">
        {% if target.provenances.is_inferred == true %}
        Could not find a provenance for this repository. Below is what Macaron has inferred.
        {% else %}
        This is the provenance found for this repository.
        {% endif %}
    </div>

    <button class="fancy-button" onclick="expandAll()">Expand All</button>
    <button class="fancy-button" onclick="collapseAll()">Collapse All</button>
    {{ macaron_macros.render_tree_view_nested_list(target.provenances.content) | indent(4) }}

    <div class='space_divider'></div>

    <div class="table_caption">Reports for Macaron checks</div>
    {{ render_checks_report(target.checks.results) | indent(4) }}

    {% else %}

    <div id= "prov_justification">
        {% if metadata.component.config_target_path == "" %}
        The analysis cannot complete because the target is not available.
        {% else %}
        The analysis for the target at {{ metadata.component.config_target_path }} is not successful.
        {% endif %}
    </div>
    {{ render_target_metadata(metadata.component) }}

    {% endif %}

    <div class='space_divider'></div>

    {#
        Display the dependencies data if it's available:
            - The total number of dependencies and unique repositories include in the analysis
            - Dependency results (The number of dependencies pass each check)
            - The status for each dependency
    #}
    {% if dependencies.analyzed_deps != 0 %}
    <div class="table_caption" id="deps_result_title">Dependency results</div>
    <div class="table_sub_caption">
    {{ dependencies.analyzed_deps }} dependencies that map to {{ dependencies.unique_dep_repos }} unique repositories have been successfully analyzed.
    </div>
    {{ render_dep_summary(dependencies.checks_summary) | indent(4) }}

    <div class="space_divider"></div>

    {{ render_dep_status(dependencies.dep_status) | indent(4) }}
    {% endif %}
{% endblock %}
