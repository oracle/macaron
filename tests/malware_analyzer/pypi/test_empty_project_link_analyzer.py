# Copyright (c) 2024 - 2024, Oracle and/or its affiliates. All rights reserved.
# Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl/.

"""Tests for heuristic detecting malicious metadata from PyPI"""
from macaron.malware_analyzer.pypi_heuristics.heuristics import HeuristicResult


def test_analyze_no_links(setup_empty_project_link_analyzer: dict) -> None:
    """Test for result failed

    Parameters
    ----------
    setup_empty_project_link_analyzer: dict
        The setup fixture returning the analyzer and api_client.
    """
    mock_api_client_fail = setup_empty_project_link_analyzer["mock_api_client_fail"]
    mock_api_client_fail.get_project_links.return_value = {}
    expected_result: tuple[HeuristicResult, dict] = (HeuristicResult.FAIL, {})

    result = setup_empty_project_link_analyzer["analyzer"].analyze(mock_api_client_fail)

    assert result == expected_result


def test_analyze_with_links(setup_empty_project_link_analyzer: dict) -> None:
    """Test for result passed

    Parameters
    ----------
    setup_empty_project_link_analyzer: dict
        The setup fixture returning the analyzer and api_client.

    """
    package_links = setup_empty_project_link_analyzer["package_links"]
    mock_api_client_pass = setup_empty_project_link_analyzer["mock_api_client_pass"]
    mock_api_client_pass.get_project_links.return_value = package_links
    expected_result: tuple[HeuristicResult, dict] = (HeuristicResult.PASS, {"project_links": package_links})

    result = setup_empty_project_link_analyzer["analyzer"].analyze(mock_api_client_pass)

    assert result == expected_result


def test_analyze_none(setup_empty_project_link_analyzer: dict) -> None:
    """Test for result skip

    Parameters
    ----------
    setup_empty_project_link_analyzer: dict
        The setup fixture returning the analyzer and api_client.

    """
    mock_api_client_pass = setup_empty_project_link_analyzer["mock_api_client_pass"]
    mock_api_client_pass.get_project_links.return_value = None
    expected_result: tuple[HeuristicResult, dict] = (HeuristicResult.SKIP, {})

    result = setup_empty_project_link_analyzer["analyzer"].analyze(mock_api_client_pass)

    assert result == expected_result
