# Copyright (c) 2024 - 2025, Oracle and/or its affiliates. All rights reserved.
# Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl/.

"""Tests for the FakeEmailAnalyzer heuristic."""


from unittest.mock import MagicMock

import pytest

from macaron.errors import HeuristicAnalyzerValueError
from macaron.malware_analyzer.pypi_heuristics.heuristics import HeuristicResult
from macaron.malware_analyzer.pypi_heuristics.metadata.fake_email import FakeEmailAnalyzer


@pytest.fixture(name="analyzer")
def analyzer_() -> FakeEmailAnalyzer:
    """Pytest fixture to create a FakeEmailAnalyzer instance."""
    return FakeEmailAnalyzer()


def test_missing_info(pypi_package_json: MagicMock, analyzer: FakeEmailAnalyzer) -> None:
    """Test when JSON 'info' key is missing in the PyPI data (should error).

    Parameters
    ----------
    pypi_package_json: MagicMock
        The PyPIPackageJsonAsset MagicMock fixture.
    analyzer: FakeEmailAnalyzer
        An initialized FakeEmailAnalyzer instance.
    """
    pypi_package_json.package_json = {}  # No 'info' key
    with pytest.raises(HeuristicAnalyzerValueError):
        analyzer.analyze(pypi_package_json)


def test_no_emails_present(pypi_package_json: MagicMock, analyzer: FakeEmailAnalyzer) -> None:
    """Test when no author_email or maintainer_email is present (should skip).

    Parameters
    ----------
    pypi_package_json: MagicMock
        The PyPIPackageJsonAsset MagicMock fixture.
    analyzer: FakeEmailAnalyzer
        An initialized FakeEmailAnalyzer instance.
    """
    pypi_package_json.package_json = {"info": {"author_email": None, "maintainer_email": None}}
    result, _ = analyzer.analyze(pypi_package_json)
    assert result == HeuristicResult.SKIP


def test_non_email(pypi_package_json: MagicMock, analyzer: FakeEmailAnalyzer) -> None:
    """Test with a non-parsable email address (should fail).

    Parameters
    ----------
    pypi_package_json: MagicMock
        The PyPIPackageJsonAsset MagicMock fixture.
    analyzer: FakeEmailAnalyzer
        An initialized FakeEmailAnalyzer instance.
    """
    pypi_package_json.package_json = {"info": {"author_email": "not an email", "maintainer_email": "also not an email"}}
    result, info = analyzer.analyze(pypi_package_json)
    assert result == HeuristicResult.FAIL

    # assert types (for mypy)
    assert isinstance(info["non_emails"], list)

    assert "not an email" in info["non_emails"]
    assert "also not an email" in info["non_emails"]


def test_invalid_email(pypi_package_json: MagicMock, analyzer: FakeEmailAnalyzer) -> None:
    """Test with an invalid email address that doesn't accept mail (should fail).

    Parameters
    ----------
    pypi_package_json: MagicMock
        The PyPIPackageJsonAsset MagicMock fixture.
    analyzer: FakeEmailAnalyzer
        An initialized FakeEmailAnalyzer instance.
    """
    pypi_package_json.package_json = {
        "info": {"author_email": "user@example.com", "maintainer_email": "other@example.com"}
    }

    result, info = analyzer.analyze(pypi_package_json)
    assert result == HeuristicResult.FAIL

    # assert types (for mypy)
    assert isinstance(info["invalid_emails"], list)

    assert "user@example.com" in info["invalid_emails"]
    assert "other@example.com" in info["invalid_emails"]


def test_valid_email(pypi_package_json: MagicMock, analyzer: FakeEmailAnalyzer) -> None:
    """Test with valid email address that does accept mail (should pass).

    Parameters
    ----------
    pypi_package_json: MagicMock
        The PyPIPackageJsonAsset MagicMock fixture.
    analyzer: FakeEmailAnalyzer
        An initialized FakeEmailAnalyzer instance.
    """
    # TODO: change this to use a test domain instead of turning off deliverability
    analyzer.check_deliverability = False
    pypi_package_json.package_json = {
        "info": {"author_email": "user@example.net", "maintainer_email": "other@example.net"}
    }
    result, info = analyzer.analyze(pypi_package_json)
    assert result == HeuristicResult.PASS

    # assert types (for mypy)
    assert isinstance(info["valid_emails"], list)

    assert "user@example.net" in info["valid_emails"]
    assert "other@example.net" in info["valid_emails"]


def test_get_emails(analyzer: FakeEmailAnalyzer) -> None:
    """Test the get_emails method extracts emails from text correctly.

    analyzer: FakeEmailAnalyzer
        An initialized FakeEmailAnalyzer instance.
    """
    email_field = "test@example.com, Another User <anotheruser@example.org>, please also email me@example.net thanks!"
    expected = ["test@example.com", "anotheruser@example.org", "me@example.net"]
    assert analyzer.get_emails(email_field) == expected

    email_field_no_email = "this is not an email"
    assert analyzer.get_emails(email_field_no_email) == []

    email_field_empty = ""
    assert analyzer.get_emails(email_field_empty) == []
