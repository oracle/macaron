# Copyright (c) 2024 - 2024, Oracle and/or its affiliates. All rights reserved.
# Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl/.

"""Tests for high release frequency heuristic."""

from macaron.malware_analyzer.pypi_heuristics.heuristics import HeuristicResult


def test_analyze_high_frequency_pass(setup_high_release_frequency_analyzer: tuple) -> None:
    """Test HighReleaseFrequencyAnalyzer with low release frequency (should pass).

    Parameters
    ----------
    setup_high_release_frequency_analyzer: tuple
        The setup fixture returning the analyzer and api_client.
    """
    analyzer, api_client = setup_high_release_frequency_analyzer

    # Mock return values
    api_client.get_releases.return_value = {
        "0.1": [{"upload_time": "2022-01-01T12:00:00"}],
        "0.2": [{"upload_time": "2022-01-10T12:00:00"}],
        "0.3": [{"upload_time": "2022-01-20T12:00:00"}],
    }

    # Call the method
    result, detail_info = analyzer.analyze(api_client)

    # Assert
    assert result == HeuristicResult.PASS
    assert detail_info == {"frequency": 9}


def test_analyze_low_frequency_fail(setup_high_release_frequency_analyzer: tuple) -> None:
    """Test HighReleaseFrequencyAnalyzer with high release frequency (should fail).

    Parameters
    ----------
    setup_high_release_frequency_analyzer: tuple
        The setup fixture returning the analyzer and api_client.
    """
    analyzer, api_client = setup_high_release_frequency_analyzer

    # Mock return values
    api_client.get_releases.return_value = {
        "0.1": [{"upload_time": "2022-01-01T12:00:00"}],
        "0.2": [{"upload_time": "2022-01-02T12:00:00"}],
        "0.3": [{"upload_time": "2022-01-04T12:00:00"}],
    }

    # Call the method
    result, detail_info = analyzer.analyze(api_client)

    # Assert
    assert result == HeuristicResult.FAIL
    assert detail_info == {"frequency": 1}


def test_analyze_no_releases_skip(setup_high_release_frequency_analyzer: tuple) -> None:
    """Test HighReleaseFrequencyAnalyzer when no releases are available (should skip).

    Parameters
    ----------
    setup_high_release_frequency_analyzer: tuple
        The setup fixture returning the analyzer and api_client.
    """
    analyzer, api_client = setup_high_release_frequency_analyzer

    # Mock return values
    api_client.get_releases.return_value = None

    # Call the method
    result, detail_info = analyzer.analyze(api_client)

    # Assert
    assert result == HeuristicResult.SKIP
    assert detail_info == {}


def test_analyze_single_release_skip(setup_high_release_frequency_analyzer: tuple) -> None:
    """Test HighReleaseFrequencyAnalyzer with a single release (should skip).

    Parameters
    ----------
    setup_high_release_frequency_analyzer: tuple
        The setup fixture returning the analyzer and api_client.
    """
    analyzer, api_client = setup_high_release_frequency_analyzer

    # Mock return values
    api_client.get_releases.return_value = {"0.1": [{"upload_time": "2022-01-01T12:00:00"}]}

    # Call the method
    result, detail_info = analyzer.analyze(api_client)

    # Assert
    assert result == HeuristicResult.SKIP
    assert detail_info == {}
