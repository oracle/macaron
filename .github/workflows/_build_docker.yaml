# Copyright (c) 2022 - 2023, Oracle and/or its affiliates. All rights reserved.
# Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl/.

# This is a reuseable workflow to build and test the Docker image. Note that this workflow does not
# push the built Docker image. This reuseable workflow needs two mandatory inputs:
#   artifact-name: The name of the artifact to download. This is the same artifact generated by _build.yaml
#   artifact-sha256: The hash to verify against the downloaded artifact.

name: Build and push Docker image
on:
  workflow_call:
    inputs:
      artifact-name:
        required: true
        type: string
      artifact-sha256:
        required: true
        type: string
permissions:
  contents: read

jobs:
  build-docker:
    runs-on: ubuntu-latest
    permissions:
      packages: read
    steps:

    - name: Check out repository
      uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8 # v3.1.0
      with:
        fetch-depth: 0

    - name: Download artifact
      uses: actions/download-artifact@9782bd6a9848b53b110e712e20e42d89988822b7 # v3.0.1
      with:
        name: ${{ inputs.artifact-name }}
        path: dist

    # Verify hashes by first computing hashes for the artifacts and then comparing them
    # against the hashes for the artifact.
    - name: Verify the artifact hash
      env:
        ARTIFACT_HASH: ${{ inputs.artifact-sha256 }}
      run: |
        set -euo pipefail
        echo "Hash of package should be $ARTIFACT_HASH."
        echo "$ARTIFACT_HASH" | base64 --decode | sha256sum --strict --check --status || exit 1

    # We need to login to access the private macaron-base image.
    # TODO: remove it when macaron-base is public.
    - name: Login to ghcr.io
      run: docker login ghcr.io --username ${{ github.actor }} --password ${{ secrets.GITHUB_TOKEN }}

    # Build the Docker image without pushing it.
    - name: Build the Docker image
      env:
        IMAGE_NAME: ghcr.io/oracle-samples/macaron
      run: ./scripts/dev_scripts/build_docker.sh "${IMAGE_NAME}" ${{ github.workspace }}

    # Run the integration tests against the built Docker image.
    - name: Test the Docker image
      env:
        # This environment variable will be picked up by run_macaron.sh.
        MACARON_IMAGE_TAG: test
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: ./scripts/dev_scripts/integration_tests_docker.sh ${{ github.workspace }} ./scripts/release_scripts/run_macaron.sh
