# Copyright (c) 2023 - 2025, Oracle and/or its affiliates. All rights reserved.
# Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl/.

# This is a reuseable workflow to build and test the Docker image. Note that this workflow does not
# push the built Docker image. This reuseable workflow needs two mandatory inputs:
#   artifact-name: The name of the artifact to download. This is the same artifact generated by _build.yaml
#   artifact-sha256: The hash to verify against the downloaded artifact.

name: Build and push Docker image
on:
  workflow_call:
    inputs:
      artifact-architecture:
        required: true
        type: string
permissions:
  contents: read

jobs:
  build-docker:
    runs-on: ubuntu-latest
    permissions:
      packages: read
    steps:

    - name: Check out repository
      uses: actions/checkout@d632683dd7b4114ad314bca15554477dd762a938 # v4.2.0
      with:
        fetch-depth: 0

    # The Docker integration tests require Python 3.11.
    - name: Set up Python
      uses: actions/setup-python@42375524e23c412d93fb67b49958b491fce71c38 # v5.4.0
      with:
        python-version: '3.11'

    - name: Download artifact
      uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
      with:
        path: downloads

    # Verify hashes by first computing hashes for the artifacts and then comparing them
    # against the hashes for the artifact.
    - name: Verify the artifact hash
      run: |
        set -euo pipefail
        cd downloads
        ARCH=${{ inputs.artifact-architecture }}
        HASH_DIR="artifacts-sha256-file-${ARCH}"
        ARTIFACT_DIR="artifacts-${ARCH}"
        HASH_FILE="${HASH_DIR}/artifacts-sha256-file-${ARCH}"

        echo "Verifying artifacts for ${ARCH}"
        echo "Decoding expected SHA256 digest:"
        DECODED_HASH=$(base64 --decode "${HASH_FILE}")
        echo "$DECODED_HASH"

        pushd "${ARTIFACT_DIR}"
        echo "$DECODED_HASH" | sha256sum --strict --check --status || {
          echo "Hash verification failed for ${ARCH}!"
          exit 1
        }
        popd

        # Copy the target dist folder to the repo directory for the subsequent steps.
        cp -r "${ARTIFACT_DIR}"/dist ../

        echo "Hash verified successfully for ${ARCH}."

    # Login so the docker build has access to the internal dependencies image
    - name: Log in to GitHub Container Registry
      run: docker login ghcr.io --username ${{ github.actor }} --password ${{ secrets.GITHUB_TOKEN }}

    # Build the Docker image without pushing it.
    - name: Build the Docker image
      env:
        IMAGE_NAME: ghcr.io/oracle/macaron
      run: make build-docker

    - name: Install dependencies for integration test utility
      run: make setup-integration-test-utility-for-docker

    # Run the integration tests against the built Docker image.
    - name: Test the Docker image
      env:
        # This environment variable will be picked up by run_macaron.sh.
        MACARON_IMAGE_TAG: test
        DOCKER_PULL: never
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: make integration-test-docker
